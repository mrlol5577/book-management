{% extends 'base.html' %}

{% block title %}
–î–æ–¥–∞—Ç–∏ –∫–Ω–∏–≥—É
{% endblock %}

{% block body %}

<div class="container" style="max-width: 900px; margin: 0 auto; padding: 20px;">

<!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
<div style="
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        margin-bottom: 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
">
        <h2 style="margin: 0; color: #333;">üìñ –î–æ–¥–∞—Ç–∏ –∫–Ω–∏–≥—É</h2>
        <h4 id="buyInput" style="margin: 0; color: #666;">üë§ –î–∞–Ω—ñ —á–∏—Ç–∞—á–∞</h4>
</div>


<!-- –§–æ—Ä–º–∞ -->
<form method="post" style="
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        display: flex;
        flex-direction: column;
        gap: 20px;
">

        <!-- –ù–∞–∑–≤–∞ + –ü–æ–∫—É–ø–µ—Ü—å -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px,1fr)); gap: 15px;">

        <div style="position: relative;">
                <input type="text" name="name_book" id="nameBookInput"
                        placeholder="üìö –ù–∞–∑–≤–∞ –∫–Ω–∏–≥–∏"
                        required
                        autocomplete="off"
                        style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em;">
                
                <!-- –ü—ñ–¥–∫–∞–∑–∫–∏ –¥–ª—è –∫–Ω–∏–≥ -->
                <div id="bookSuggestions" style="
                        background: white;
                        border: 1px solid #ddd;
                        border-radius: 6px;
                        margin-top: 5px;
                        display: none;
                        position: absolute;
                        width: 100%;
                        z-index: 1000;
                        max-height: 200px;
                        overflow-y: auto;
                "></div>
        </div>

        <input type="text" name="buyer" id="buyerInput"
                placeholder="üë§ –Ü–º'—è —Ç–∞ —Ñ–∞–º—ñ–ª—ñ—è"
                style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em;">
        </div>


        <!-- –ê–≤—Ç–æ—Ä + –¢–µ–ª–µ—Ñ–æ–Ω -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px,1fr)); gap: 15px;">

        <input type="text" name="author" id="authorInput"
                placeholder="‚úçÔ∏è –ê–≤—Ç–æ—Ä"
                required
                style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em;">

        <input type="text" name="phone" id="phoneInput"
                placeholder="üìû –¢–µ–ª–µ—Ñ–æ–Ω"
                style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em;">
        </div>


        <!-- EAN -->
        <input type="text" name="ean" id="eanInput"
        placeholder="üî¢ EAN –∫–æ–¥"
        style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em;">


        <!-- –î–∞—Ç–∞ -->
        <input type="date" name="date" id="dateInput"
        required
        style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em;">


        <!-- –ö–Ω–æ–ø–∫–∞ + –°—Ç–∞—Ç—É—Å -->
        <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: center;">

                <button type="submit"
                class="btn btn-success"
                style="padding: 10px 25px; border-radius: 8px; font-size: 1em;">
                ‚ûï –î–æ–¥–∞—Ç–∏
                </button>

                <select name="stat" id="buyerSelect"
                style="padding: 10px; border-radius: 8px; border: 2px solid #e0e0e0; font-size: 1em;">

                <option value="–¥–æ—Å—Ç—É–ø–Ω–∞">‚úÖ –ß–∏—Ç–∞—á–∞ –Ω–µ–º–∞</option>
                <option value="–≤–∏–¥–∞–Ω–∞">üìï –ß–∏—Ç–∞—á —î</option>

                </select>

        </div>

        </form>

</div>


<!-- JS -->
<script>

const buyerSelect = document.getElementById('buyerSelect');
const phoneInput = document.getElementById('phoneInput');
const buyerInput = document.getElementById('buyerInput');
const buyInput = document.getElementById('buyInput');

const dateInput = document.getElementById('dateInput');
const today = new Date().toISOString().split('T')[0];
dateInput.value = today;


function updateFields() {

        if (buyerSelect.value === '–¥–æ—Å—Ç—É–ø–Ω–∞') {

        phoneInput.style.display = 'none';
        buyerInput.style.display = 'none';
        buyInput.style.display = 'none';

        } else {

        phoneInput.style.display = 'block';
        buyerInput.style.display = 'block';
        buyInput.style.display = 'block';

        }
}


updateFields();
buyerSelect.addEventListener('change', updateFields);

// ====== –ü–û–®–£–ö –Ü–°–ù–£–Æ–ß–ò–• –ö–ù–ò–ì ======

const nameBookInput = document.getElementById('nameBookInput');
const authorInput = document.getElementById('authorInput');
const eanInput = document.getElementById('eanInput');
const bookSuggestions = document.getElementById('bookSuggestions');

let bookTimeout = null;

nameBookInput.addEventListener('input', function() {
        clearTimeout(bookTimeout);

        const query = this.value.trim();

        if (query.length < 2) {
                bookSuggestions.style.display = 'none';
                return;
        }

        bookTimeout = setTimeout(() => {
                fetch(`/search_books?q=${encodeURIComponent(query)}`)
                        .then(res => res.json())
                        .then(data => {
                                bookSuggestions.innerHTML = '';

                                if (data.results.length === 0) {
                                        bookSuggestions.style.display = 'none';
                                        return;
                                }

                                data.results.forEach(book => {
                                        const div = document.createElement('div');
                                        
                                        div.innerHTML = `
                                                <div style="padding: 10px; border-bottom: 1px solid #eee;">
                                                        <strong style="color: #333;">üìñ ${book.name_book}</strong><br>
                                                        <small style="color: #666;">‚úçÔ∏è ${book.author} | üî¢ ${book.ean}</small><br>
                                                        <span style="color: ${book.stat === '–≤–∏–¥–∞–Ω–∞' ? '#dc3545' : '#28a745'}; font-size: 0.9em;">
                                                                ${book.stat === '–≤–∏–¥–∞–Ω–∞' ? 'üìï –í–∏–¥–∞–Ω–∞' : '‚úÖ –î–æ—Å—Ç—É–ø–Ω–∞'}
                                                        </span>
                                                </div>
                                        `;

                                        div.style.cursor = 'pointer';

                                        div.addEventListener('click', () => {
                                                nameBookInput.value = book.name_book;
                                                authorInput.value = book.author;
                                                eanInput.value = book.ean;
                                                bookSuggestions.style.display = 'none';
                                        });

                                        bookSuggestions.appendChild(div);
                                });

                                bookSuggestions.style.display = 'block';
                        });
        }, 300);
});

// –ó–∞–∫—Ä–∏—Ç—Ç—è –ø—ñ–¥–∫–∞–∑–æ–∫ –ø—Ä–∏ –∫–ª—ñ–∫—É –ø–æ–∑–∞ –Ω–∏–º–∏
document.addEventListener('click', function(e) {
        if (!nameBookInput.contains(e.target) && !bookSuggestions.contains(e.target)) {
                bookSuggestions.style.display = 'none';
        }
});

</script>


<style>

input:focus, select:focus {
        outline: none;
        border-color: #667eea;
}

::placeholder {
        color: #999;
}

#bookSuggestions div:hover {
        background-color: #f8f9fa;
}

</style>

{% endblock %}