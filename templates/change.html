{% extends 'base.html' %}

{% block title %}
{{ book.name_book }}
{% endblock %}

{% block body %}

<div class="container" style="max-width: 900px; margin: 0 auto; padding: 20px;">
    
    <!-- –ù–∞–∑–≤–∞ –∫–Ω–∏–≥–∏ -->
    <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); margin-bottom: 20px;">
        <h1 style="color: #333; margin: 0; font-size: 2em; display: flex; align-items: center; gap: 12px;">
            üìñ {{ book.name_book }}
        </h1>
        
        <!-- –ö–Ω–æ–ø–∫–∏ –¥—ñ–π -->
        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px;">
            <a href="/books/{{ book.id }}/edit"
                class="btn btn-primary"
                style="padding: 12px 24px; font-size: 1em; border-radius: 8px; text-decoration: none;">
                ‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –∫–Ω–∏–≥—É
            </a>
        </div>
    </div>
    
    <!-- –°—Ç–∞—Ç—É—Å –∫–Ω–∏–≥–∏ -->
    <div class="gigi" style="margin-bottom: 30px;">
        <div class="didi" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); color: white; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h3 class="tutu" style="margin: 0 0 10px 0; font-size: 1.3em;">üìö –°—Ç–∞—Ç—É—Å: {{ book.stat }} </h3>
                {% if book.stat == '–≤–∏–¥–∞–Ω–∞' %}
                <p class="tutu" style="margin: 5px 0; font-size: 1.1em;">üë§ –ö–Ω–∏–≥–∞ —É: <strong>{{ book.buyer }}</strong></p>
                <p class="tutu" style="margin: 5px 0; font-size: 1.1em;">üìû –ù–æ–º–µ—Ä: <strong>{{ book.phone }}</strong></p>
                {% else %}
                <p class="tutu" style="margin: 5px 0; font-size: 1.1em; opacity: 0.9;">‚úÖ –ö–Ω–∏–≥–∞ –≤—ñ–ª—å–Ω–∞</p>
                {% endif %}
            </div>
            {% if current_user.is_authenticated and current_user.role == 'superadmin' %}
            <a href="/books/{{ book.id }}/del"
                class="btn btn-danger"
                style="padding: 12px 24px; font-size: 1em; border-radius: 8px; text-decoration: none;">
                –í–∏–¥–∞–ª–∏—Ç–∏ –∫–Ω–∏–≥—É
            </a>
            {% endif %}
        </div>
    </div>

    <!-- –§–æ—Ä–º–∞ –Ω–æ–≤–æ–≥–æ —á–∏—Ç–∞—á–∞ -->
    <div class="didi" style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); margin-bottom: 30px;">
        <h2 style="color: #333; margin-bottom: 25px; font-size: 1.8em; border-bottom: 3px solid #667eea; padding-bottom: 10px; display: inline-block;">‚úèÔ∏è –û–Ω–æ–≤–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å</h2>
        
        <form method="post" class="from-control">
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; color: #555; font-weight: 600;">–°—Ç–∞—Ç—É—Å –∫–Ω–∏–≥–∏:</label>
                <select class="state" name="stat" id="buyerSelect" style="width: 100%;  border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em; background-color: white; cursor: pointer; transition: border 0.3s;">
                    <option value="–≤–∏–¥–∞–Ω–∞" {% if book.stat == '–≤–∏–¥–∞–Ω–∞' %}selected{% endif %}>–í–∏–¥–∞—Ç–∏</option>
                    <option value="–¥–æ—Å—Ç—É–ø–Ω–∞" {% if book.stat == '–¥–æ—Å—Ç—É–ø–Ω–∞' %}selected{% endif %}>–ü–æ–≤–µ—Ä–Ω—É—Ç–∏</option>
                </select>
            </div>
            
            <div id="readerFields" style="transition: all 0.3s ease;">
                <div style="margin-bottom: 15px; position: relative;">
                    <label style="display: block; margin-bottom: 8px; color: #555; font-weight: 600;">
                        –Ü–º'—è —á–∏—Ç–∞—á–∞:
                    </label>

                    <input type="text"
                        name="buyer"
                        class="text_customer"
                        value="{{book.buyer}}"
                        placeholder="–í–≤–µ–¥—ñ—Ç—å —ñ–º'—è"
                        id="buyerInput"
                        style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em; transition: border 0.3s;">

                    <!-- –û–¶–ï –î–û–î–ê–Ñ–ú–û -->
                    <div id="suggestions" style="
                        background: white;
                        border: 1px solid #ddd;
                        border-radius: 6px;
                        margin-top: 5px;
                        display: none;
                        position: absolute;
                        width: 100%;
                        z-index: 1000;
                        max-height: 150px;
                        overflow-y: auto;
                    "></div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: #555; font-weight: 600;">–ü—Ä—ñ–∑–≤–∏—â–µ —á–∏—Ç–∞—á–∞:</label>
                    <input type="text" name="surname" class="text_customer" value="{{book.surname}}" placeholder="–í–≤–µ–¥—ñ—Ç—å –ø—Ä—ñ–∑–≤–∏—â–µ" id="surnameInput" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em; transition: border 0.3s;">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: #555; font-weight: 600;">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É:</label>
                    <input type="text" name="phone" class="text_customer" value="{{book.phone}}" placeholder="–í–≤–µ–¥—ñ—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É" id="phoneInput" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em; transition: border 0.3s;">
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label for="enddate" style="display: block; margin-bottom: 8px; color: #555; font-weight: 600;">üìÖ –î–∞—Ç–∞ –∑–∞–∫—ñ–Ω—á–µ–Ω–Ω—è:</label>
                <input type="date" name="enddate" class="date" id="enddateInput" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em;">
            </div>
            
            <button id="da" class="btn btn-success" type="submit" style="width: 100%; padding: 15px; font-size: 1.1em; border-radius: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;">
                –û–Ω–æ–≤–∏—Ç–∏
            </button>
        </form>
    </div>

    <!-- –Ü—Å—Ç–æ—Ä—ñ—è –±—Ä–æ–Ω—é–≤–∞–Ω—å -->
    <div style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08);">
        <h2 style="color: #333; margin-bottom: 20px; font-size: 1.5em; border-bottom: 3px solid #667eea; padding-bottom: 10px; display: inline-block;">üìú –Ü—Å—Ç–æ—Ä—ñ—è –±—Ä–æ–Ω—é–≤–∞–Ω—å</h2>
        
        {% if book.history %}
        <div class="history-section">
            {% set history_entries = book.history.split(' | ') %}
            <ul style="list-style-type: none; padding-left: 0; margin: 0;">
                {% for entry in history_entries %}
                <li style="padding: 15px; margin-bottom: 10px; background: #f8f9fa; border-left: 4px solid #667eea; border-radius: 6px; transition: transform 0.2s;">
                    {{ entry }}
                </li>
                {% endfor %}
            </ul>
        </div>
        {% else %}
        <div class="history-section" style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 8px;">
            <p style="color: #999; font-size: 1.1em; margin: 0;">üì≠ –Ü—Å—Ç–æ—Ä—ñ—è –±—Ä–æ–Ω—é–≤–∞–Ω—å –≤—ñ–¥—Å—É—Ç–Ω—è</p>
        </div>
        {% endif %}
    </div>
</div> 

<style>
    input:focus, select:focus {
        outline: none;
        border-color: #667eea !important;
    }
    
    button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    
    .history-section li:hover {
        transform: translateX(5px);
    }
</style>

<script>
    const select = document.getElementById('buyerSelect');
    const fields = document.getElementById('readerFields');
    const phone = document.getElementById('phoneInput');
    const buyer = document.getElementById('buyerInput');
    const enddate = document.getElementById('enddateInput');
    const surname = document.getElementById('surnameInput');
    
    enddate.value = new Date().toISOString().split('T')[0];

    function toggle() {
        if (select.value === '–¥–æ—Å—Ç—É–ø–Ω–∞') {
            fields.style.display = 'none';
            phone.value = '';
            buyer.value = '';
        } else {
            fields.style.display = 'block';
        }
    }

    toggle();
    select.addEventListener('change', toggle);
const buyerInput = document.getElementById('buyerInput');
const surnameInput = document.getElementById('surnameInput');
const phoneInput = document.getElementById('phoneInput');
const suggestions = document.getElementById('suggestions');

let timeout = null;

buyerInput.addEventListener('input', function () {

    clearTimeout(timeout);

    const query = this.value.trim();

    if (query.length < 2) {
        suggestions.style.display = 'none';
        return;
    }

    timeout = setTimeout(() => {

        fetch(`/search_reader?q=${query}`)
            .then(res => res.json())
            .then(data => {

                suggestions.innerHTML = '';

                if (data.results.length === 0) {
                    suggestions.style.display = 'none';
                    return;
                }

                data.results.forEach(r => {

                    const div = document.createElement('div');

                    div.textContent = `${r.name} ${r.surname} (${r.phone})`;

                    div.style.padding = '8px';
                    div.style.cursor = 'pointer';

                    div.addEventListener('click', () => {

                        buyerInput.value = r.name;
                        surnameInput.value = r.surname;
                        phoneInput.value = r.phone;

                        suggestions.style.display = 'none';
                    });

                    suggestions.appendChild(div);
                });

                suggestions.style.display = 'block';
            });

    }, 300);
});
</script>

{% endblock %}